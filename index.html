<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>杜佳甲老婆</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body { height:100%; margin:0; overflow:hidden; background:#000; font-family:Helvetica, sans-serif; }
        #container { width:100%; height:100%; }
        .element { width:150px; height:150px; box-shadow:0 0 12px rgba(0,255,255,.5); border:1px solid rgba(127,255,255,.25); display:block; }
        .element canvas { display:block; width:150px; height:150px; border-radius:4px; }
        #menu { position:fixed; bottom:20px; width:100%; text-align:center; z-index:10; }
        button { background:transparent; border:1px solid rgba(127,255,255,.75); color:rgba(127,255,255,.75); padding:6px 12px; margin:0 5px; cursor:pointer; }
        .show_info { position:fixed; top:30%; left:0; right:0; margin:auto; width:340px; background:rgba(0,0,0,.7); padding:10px; border-radius:6px; display:none; box-shadow:0 0 10px #fff; text-align:center; z-index:20; }
        .show_info img { width:240px; max-width:100%; border-radius:5px; }
        .intro { color:#fff; margin-top:10px; }
    </style>

    <!-- 如果仓库里已有 animate.min.css，可以把下面这行改成本地路径 "css/animate.min.css" -->
    <link rel="stylesheet" href="css/animate.min.css">
</head>
<body>
<div id="container"></div>

<div id="menu">
    <button id="table">表格</button>
    <button id="sphere">球形</button>
    <button id="helix">螺旋</button>
    <button id="grid">网格</button>
</div>

<div class="show_info animated">
    <!-- 注意：图片在你的仓库根目录（不是 img/ 下），因此使用 ./d1.jpg -->
    <img src="./d1.jpg" alt="info image">
    <div class="intro">愿与君朝朝暮暮，朝为始，暮不至</div>
</div>

<!-- CDN 脚本：three + controls + renderer + tween + jquery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/TrackballControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/renderers/CSS3DRenderer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

<script>
/* ========== 数据 ========== */
// 注意：图片放在仓库根目录（你的仓库里已有 d.jpg, d1.jpg 等），使用 './d.jpg' 路径
const personArray = [];
const COUNT = 200; // 总项数（手机上可调小一些，例如 120）
for (let i = 0; i < COUNT; i++) {
    personArray.push({ image: './d.jpg' });
}

const table = personArray.map((p, i) => ({
    image: p.image,
    p_x: (i % 20) + 1,
    p_y: Math.floor(i / 20) + 1
}));

/* ========== Three.js 初始化 ========== */
let camera, scene, renderer, controls;
const objects = [];
const targets = { table: [], sphere: [], helix: [], grid: [] };

init();
animate();

function init() {
    camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
    camera.position.z = 3000;
    scene = new THREE.Scene();

    const DISPLAY_SIZE = 150; // CSS 显示大小

    table.forEach((item, i) => {
        const element = document.createElement('div');
        element.className = 'element';
        element.style.width = DISPLAY_SIZE + 'px';
        element.style.height = DISPLAY_SIZE + 'px';

        // canvas 按 devicePixelRatio 绘制以提高清晰度
        const canvas = document.createElement('canvas');
        const dpr = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = Math.round(DISPLAY_SIZE * dpr);
        canvas.height = Math.round(DISPLAY_SIZE * dpr);
        canvas.style.width = DISPLAY_SIZE + 'px';
        canvas.style.height = DISPLAY_SIZE + 'px';
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // 载入图片并绘制到 canvas（cover 模式）
        const img = new Image();
        img.onload = function() {
            const sw = img.width, sh = img.height;
            const dw = canvas.width, dh = canvas.height;
            const imgRatio = sw / sh;
            const canvasRatio = dw / dh;
            let sx = 0, sy = 0, sWidth = sw, sHeight = sh;
            if (imgRatio > canvasRatio) {
                sWidth = Math.round(sh * canvasRatio);
                sx = Math.round((sw - sWidth) / 2);
            } else {
                sHeight = Math.round(sw / canvasRatio);
                sy = Math.round((sh - sHeight) / 2);
            }
            ctx.clearRect(0,0,dw,dh);
            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, dw, dh);
        };
        img.crossOrigin = "anonymous";
        img.src = item.image;

        element.appendChild(canvas);

        const cssObj = new THREE.CSS3DObject(element);
        cssObj.position.set(Math.random() * 4000 - 2000, Math.random() * 4000 - 2000, Math.random() * 4000 - 2000);
        scene.add(cssObj);
        objects.push(cssObj);

        const target = new THREE.Object3D();
        target.position.x = item.p_x * 140 - 1330;
        target.position.y = - item.p_y * 180 + 990;
        targets.table.push(target);
    });

    // sphere
    const spherical = new THREE.Spherical();
    for (let i = 0, l = objects.length; i < l; i++) {
        const obj = new THREE.Object3D();
        const phi = Math.acos(-1 + (2 * i) / l);
        const theta = Math.sqrt(l * Math.PI) * phi;
        spherical.set(800, phi, theta);
        obj.position.setFromSpherical(spherical);
        targets.sphere.push(obj);
    }

    // helix
    const cylindrical = new THREE.Cylindrical();
    for (let i = 0, l = objects.length; i < l; i++) {
        const obj = new THREE.Object3D();
        cylindrical.set(900, i * 0.175 + Math.PI, - i * 5 + 450);
        obj.position.setFromCylindrical(cylindrical);
        targets.helix.push(obj);
    }

    // grid
    for (let i = 0; i < objects.length; i++) {
        const obj = new THREE.Object3D();
        obj.position.x = (i % 5) * 400 - 800;
        obj.position.y = - (Math.floor(i / 5) % 5) * 300 + 500;
        obj.position.z = Math.floor(i / 25) * 200 - 800;
        targets.grid.push(obj);
    }

    // CSS3DRenderer
    renderer = new THREE.CSS3DRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('container').appendChild(renderer.domElement);

    // TrackballControls
    controls = new THREE.TrackballControls(camera, renderer.domElement);
    controls.rotateSpeed = 0.5;
    controls.minDistance = 500;
    controls.maxDistance = 6000;
    controls.addEventListener('change', render);

    // 按钮事件
    document.getElementById('table').onclick = () => transform(targets.table, 2000);
    document.getElementById('sphere').onclick = () => transform(targets.sphere, 2000);
    document.getElementById('helix').onclick = () => transform(targets.helix, 2000);
    document.getElementById('grid').onclick = () => transform(targets.grid, 2000);

    transform(targets.table, 2000);
    window.addEventListener('resize', onResize, false);

    // 简单的弹窗轮播（用 jQuery 的 animate.css 类）
    let cur = 0;
    setInterval(() => {
        const $info = $('.show_info');
        const inAnim = 'fadeInDown';
        const outAnim = 'fadeOutUp';
        $info.show().removeClass(outAnim).addClass(inAnim);
        // change image in popup (use d1.jpg as example)
        $info.find('img').attr('src', './d1.jpg');
        setTimeout(() => {
            $info.removeClass(inAnim).addClass(outAnim);
            setTimeout(() => $info.hide().removeClass(outAnim), 900);
        }, 1700);
        cur = (cur + 1) % objects.length;
    }, 4500);
}

function transform(targetsArr, duration) {
    TWEEN.removeAll();
    for (let i = 0; i < objects.length; i++) {
        const object = objects[i];
        const target = targetsArr[i] || targetsArr[i % targetsArr.length];
        new TWEEN.Tween(object.position)
            .to({ x: target.position.x, y: target.position.y, z: target.position.z }, Math.random() * duration + duration)
            .easing(TWEEN.Easing.Exponential.InOut)
            .start();

        new TWEEN.Tween(object.rotation)
            .to({ x: target.rotation.x, y: target.rotation.y, z: target.rotation.z }, Math.random() * duration + duration)
            .easing(TWEEN.Easing.Exponential.InOut)
            .start();
    }

    new TWEEN.Tween(this).to({}, duration * 2).onUpdate(render).start();
}

function animate() {
    requestAnimationFrame(animate);
    TWEEN.update();
    if (controls) controls.update();
    // rotate scene slowly for a nicer look
    if (scene) scene.rotation.y += 0.008;
    render();
}

function render() {
    renderer.render(scene, camera);
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>
