<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>3D图片画廊</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="3D图片展示画廊">

<style>
/* 重置和基础样式 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    font-family: 'Arial', sans-serif;
}

/* 3D场景容器 */
#scene-container {
    position: absolute;
    width: 100%;
    height: 100%;
    perspective: 1500px;
    transform-style: preserve-3d;
    transition: transform 0.1s linear;
    will-change: transform;
}

/* 图片项 */
.picture-item {
    position: absolute;
    width: 180px;
    height: 180px;
    transform-style: preserve-3d;
    transition: transform 1s cubic-bezier(0.25, 0.1, 0.25, 1);
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 15px rgba(0, 200, 255, 0.4);
    background: rgba(10, 20, 30, 0.8);
    border: 2px solid rgba(0, 200, 255, 0.5);
}

.picture-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: transform 0.3s;
}

.picture-item:hover img {
    transform: scale(1.1);
}

.picture-item:hover {
    box-shadow: 0 0 25px rgba(255, 100, 255, 0.7);
    border-color: rgba(255, 100, 255, 0.8);
    z-index: 1000;
}

/* 控制面板 */
.controls {
    position: fixed;
    bottom: 20px;
    left: 0;
    width: 100%;
    text-align: center;
    z-index: 1000;
    padding: 15px 0;
    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
}

.btn {
    background: rgba(0, 0, 0, 0.7);
    border: 2px solid #0af;
    color: #0af;
    padding: 10px 20px;
    margin: 0 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s;
    min-width: 100px;
    outline: none;
}

.btn:hover {
    background: rgba(0, 170, 255, 0.3);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 170, 255, 0.4);
}

.btn.active {
    background: rgba(0, 170, 255, 0.5);
    color: #fff;
    border-color: #fff;
}

/* 信息显示 */
.info {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid rgba(0, 200, 255, 0.4);
    font-size: 12px;
    z-index: 1000;
    min-width: 150px;
}

.info div {
    margin: 4px 0;
    color: #0af;
}

.info span {
    color: #fff;
    margin-left: 5px;
}

/* 加载提示 */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    color: #0af;
    font-size: 20px;
}

.loading .progress {
    width: 300px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    margin-top: 20px;
    overflow: hidden;
}

.loading .progress-bar {
    height: 100%;
    background: #0af;
    width: 0%;
    transition: width 0.3s;
}

/* 提示消息 */
.message {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 100, 200, 0.9);
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
}

/* 操作指南 */
.instructions {
    position: fixed;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.8);
    padding: 15px;
    border-radius: 6px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    font-size: 12px;
    z-index: 1000;
    max-width: 300px;
}

.instructions h3 {
    color: #0af;
    margin-bottom: 10px;
}

.instructions p {
    margin: 5px 0;
    color: #ccc;
}
</style>
</head>

<body>
<!-- 加载提示 -->
<div class="loading" id="loading">
    <div>加载3D画廊中...</div>
    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
</div>

<!-- 操作指南 -->
<div class="instructions">
    <h3>操作说明</h3>
    <p>鼠标拖拽: 旋转视角</p>
    <p>鼠标滚轮: 缩放视图</p>
    <p>点击图片: 放大查看</p>
    <p>下方按钮: 切换布局</p>
    <h3>键盘快捷键</h3>
    <p>1-4: 切换布局</p>
    <p>R: 重置视图</p>
    <p>方向键: 旋转视角</p>
</div>

<!-- 信息显示 -->
<div class="info">
    <div>图片数量: <span id="picCount">0</span></div>
    <div>当前布局: <span id="currentLayout">表格</span></div>
    <div>FPS: <span id="fps">60</span></div>
</div>

<!-- 3D场景容器 -->
<div id="scene-container"></div>

<!-- 提示消息 -->
<div class="message" id="message"></div>

<!-- 控制面板 -->
<div class="controls">
    <button class="btn active" onclick="setLayout('table')">表格</button>
    <button class="btn" onclick="setLayout('sphere')">球形</button>
    <button class="btn" onclick="setLayout('helix')">螺旋</button>
    <button class="btn" onclick="setLayout('grid')">网格</button>
    <button class="btn" onclick="setLayout('random')">随机</button>
    <button class="btn" onclick="resetView()">重置</button>
</div>

<script>
// ====== 全局变量 ======
let scene = document.getElementById('scene-container');
let pictures = [];
let currentLayout = 'table';
let isDragging = false;
let lastMouseX = 0, lastMouseY = 0;
let rotationX = 0, rotationY = 0;
let targetRotationX = 0, targetRotationY = 0;
let zoom = 1;
let targetZoom = 1;
let autoRotate = true;
let autoRotateSpeed = 0.002;
let lastTime = performance.now();
let frameCount = 0;
let fps = 60;
let animationId = null;
let isInitialized = false;

// 图片文件列表 - 请根据实际情况修改
const imageFiles = [
    'd1.jpg',
    'd1.jpg',
    'd1.jpg',
    'd1.jpg',
    'd1.jpg',
    'd1.jpg'
];

// 布局配置
const layoutConfigs = {
    table: { rows: 6, cols: 6, spacing: 220 },
    sphere: { radius: 900, items: 36 },
    helix: { radius: 700, height: 1800, turns: 4 },
    grid: { x: 4, y: 3, z: 3, spacing: 240 }
};

// ====== 初始化函数 ======
function init() {
    console.log('开始初始化3D画廊...');
    
    // 创建图片元素
    createPictures(36);
    
    // 设置初始布局
    setLayout('table');
    
    // 设置事件监听
    setupEventListeners();
    
    // 隐藏加载提示
    setTimeout(() => {
        document.getElementById('loading').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            showMessage('3D画廊加载完成！', 2000);
        }, 500);
    }, 1000);
    
    // 开始动画循环
    startAnimation();
    
    isInitialized = true;
    console.log('3D画廊初始化完成');
}

// 创建图片元素
function createPictures(count) {
    for (let i = 0; i < count; i++) {
        const picture = document.createElement('div');
        picture.className = 'picture-item';
        picture.dataset.index = i;
        
        const img = document.createElement('img');
        const imgIndex = i % imageFiles.length;
        img.src = imageFiles[imgIndex];
        img.alt = `图片 ${i + 1}`;
        img.loading = 'lazy';
        
        // 图片加载错误处理
        img.onerror = function() {
            console.warn(`图片加载失败: ${imageFiles[imgIndex]}`);
            
            // 创建替代显示
            const placeholder = document.createElement('div');
            placeholder.style.cssText = `
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #1a1a2e, #16213e);
                display: flex;
                align-items: center;
                justify-content: center;
                color: #0af;
                font-size: 24px;
                font-weight: bold;
            `;
            placeholder.textContent = i + 1;
            picture.appendChild(placeholder);
            
            // 移除错误的img元素
            picture.removeChild(img);
            
            // 更新加载进度
            updateProgress(i + 1, count);
        };
        
        // 图片加载成功
        img.onload = function() {
            updateProgress(i + 1, count);
        };
        
        // 点击查看大图
        picture.onclick = function(e) {
            e.stopPropagation();
            const imgElement = this.querySelector('img');
            if (imgElement) {
                showFullscreen(imgElement.src);
            }
        };
        
        picture.appendChild(img);
        scene.appendChild(picture);
        pictures.push(picture);
    }
    
    document.getElementById('picCount').textContent = count;
    console.log(`创建了 ${count} 个图片元素`);
}

// 更新加载进度
function updateProgress(current, total) {
    const progress = Math.round((current / total) * 100);
    document.getElementById('progressBar').style.width = `${progress}%`;
}

// 设置布局
function setLayout(layout) {
    if (layout === 'random') {
        const layouts = ['table', 'sphere', 'helix', 'grid'];
        layout = layouts[Math.floor(Math.random() * layouts.length)];
    }
    
    currentLayout = layout;
    
    // 更新按钮状态
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 更新信息显示
    document.getElementById('currentLayout').textContent = 
        layout === 'table' ? '表格' :
        layout === 'sphere' ? '球形' :
        layout === 'helix' ? '螺旋' :
        layout === 'grid' ? '网格' : '随机';
    
    // 应用布局
    applyLayout(layout);
    
    showMessage(`已切换到${document.getElementById('currentLayout').textContent}布局`, 1500);
}

// 应用布局
function applyLayout(layout) {
    const config = layoutConfigs[layout];
    if (!config || !pictures.length) return;
    
    pictures.forEach((pic, index) => {
        let x, y, z;
        
        switch(layout) {
            case 'table':
                const rows = config.rows;
                const cols = config.cols;
                const spacing = config.spacing;
                const startX = -(cols - 1) * spacing / 2;
                const startY = -(rows - 1) * spacing / 2;
                
                const row = Math.floor(index / cols);
                const col = index % cols;
                x = startX + col * spacing;
                y = startY + row * spacing;
                z = 0;
                break;
                
            case 'sphere':
                const phi = Math.acos(-1 + (2 * index) / pictures.length);
                const theta = Math.sqrt(pictures.length * Math.PI) * phi;
                x = config.radius * Math.sin(phi) * Math.cos(theta);
                y = config.radius * Math.cos(phi);
                z = config.radius * Math.sin(phi) * Math.sin(theta);
                break;
                
            case 'helix':
                const t = index / pictures.length;
                const angle = t * Math.PI * 2 * config.turns;
                x = config.radius * Math.cos(angle);
                y = (t - 0.5) * config.height;
                z = config.radius * Math.sin(angle);
                break;
                
            case 'grid':
                const xCount = config.x;
                const yCount = config.y;
                const zCount = config.z;
                
                const xi = index % xCount;
                const yi = Math.floor(index / xCount) % yCount;
                const zi = Math.floor(index / (xCount * yCount));
                
                x = (xi - (xCount - 1) / 2) * config.spacing;
                y = (yi - (yCount - 1) / 2) * config.spacing;
                z = (zi - (zCount - 1) / 2) * config.spacing;
                break;
                
            default:
                x = y = z = 0;
        }
        
        // 应用位置变换
        pic.style.transform = `translate3d(${x}px, ${y}px, ${z}px)`;
    });
}

// 重置视图
function resetView() {
    targetRotationX = 0;
    targetRotationY = 0;
    targetZoom = 1;
    rotationX = 0;
    rotationY = 0;
    zoom = 1;
    
    setLayout('table');
    showMessage('视图已重置', 1500);
}

// 显示全屏图片
function showFullscreen(src) {
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    
    const img = document.createElement('img');
    img.src = src;
    img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 0 50px rgba(0, 200, 255, 0.5);
        transform: scale(0.9);
        transition: transform 0.3s;
    `;
    
    overlay.appendChild(img);
    document.body.appendChild(overlay);
    
    // 淡入
    setTimeout(() => {
        overlay.style.opacity = '1';
        img.style.transform = 'scale(1)';
    }, 10);
    
    // 点击关闭
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            overlay.style.opacity = '0';
            img.style.transform = 'scale(0.9)';
            setTimeout(() => {
                document.body.removeChild(overlay);
            }, 300);
        }
    };
}

// 显示消息
function showMessage(text, duration = 2000) {
    const message = document.getElementById('message');
    message.textContent = text;
    message.style.opacity = '1';
    
    setTimeout(() => {
        message.style.opacity = '0';
    }, duration);
}

// 设置事件监听
function setupEventListeners() {
    // 鼠标拖拽旋转
    scene.addEventListener('mousedown', (e) => {
        isDragging = true;
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
        autoRotate = false;
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - lastMouseX;
        const deltaY = e.clientY - lastMouseY;
        
        targetRotationY += deltaX * 0.005;
        targetRotationX += deltaY * 0.005;
        
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
        setTimeout(() => { autoRotate = true; }, 3000);
    });
    
    // 鼠标滚轮缩放
    scene.addEventListener('wheel', (e) => {
        e.preventDefault();
        targetZoom += e.deltaY * -0.001;
        targetZoom = Math.max(0.3, Math.min(3, targetZoom));
    });
    
    // 触摸事件
    scene.addEventListener('touchstart', (e) => {
        isDragging = true;
        lastMouseX = e.touches[0].clientX;
        lastMouseY = e.touches[0].clientY;
        autoRotate = false;
    });
    
    scene.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.touches[0].clientX - lastMouseX;
        const deltaY = e.touches[0].clientY - lastMouseY;
        
        targetRotationY += deltaX * 0.005;
        targetRotationX += deltaY * 0.005;
        
        lastMouseX = e.touches[0].clientX;
        lastMouseY = e.touches[0].clientY;
    });
    
    scene.addEventListener('touchend', () => {
        isDragging = false;
        setTimeout(() => { autoRotate = true; }, 3000);
    });
    
    // 键盘快捷键
    document.addEventListener('keydown', (e) => {
        switch(e.key) {
            case ' ':
                e.preventDefault();
                setLayout('random');
                break;
            case 'r':
            case 'R':
                resetView();
                break;
            case '1':
                setLayout('table');
                break;
            case '2':
                setLayout('sphere');
                break;
            case '3':
                setLayout('helix');
                break;
            case '4':
                setLayout('grid');
                break;
            case 'Escape':
                // 关闭全屏图片
                const overlay = document.querySelector('[style*="z-index: 3000"]');
                if (overlay) overlay.click();
                break;
            case 'ArrowLeft':
                targetRotationY += 0.1;
                break;
            case 'ArrowRight':
                targetRotationY -= 0.1;
                break;
            case 'ArrowUp':
                targetRotationX += 0.1;
                break;
            case 'ArrowDown':
                targetRotationX -= 0.1;
                break;
        }
    });
}

// 开始动画循环
function startAnimation() {
    function animate(currentTime) {
        animationId = requestAnimationFrame(animate);
        
        // 计算FPS
        frameCount++;
        if (currentTime - lastTime >= 1000) {
            fps = frameCount;
            frameCount = 0;
            lastTime = currentTime;
            document.getElementById('fps').textContent = fps;
        }
        
        // 平滑插值
        rotationX += (targetRotationX - rotationX) * 0.1;
        rotationY += (targetRotationY - rotationY) * 0.1;
        zoom += (targetZoom - zoom) * 0.1;
        
        // 自动旋转
        if (autoRotate && !isDragging) {
            targetRotationY += autoRotateSpeed;
        }
        
        // 应用变换
        scene.style.transform = `
            rotateX(${rotationX}rad)
            rotateY(${rotationY}rad)
            scale(${zoom})
        `;
    }
    
    // 开始动画
    animationId = requestAnimationFrame(animate);
}

// 停止动画循环
function stopAnimation() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始初始化...');
    
    // 开始初始化
    setTimeout(init, 100);
});

// 页面可见性变化
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('页面隐藏，暂停动画');
        stopAnimation();
    } else {
        console.log('页面显示，继续动画');
        startAnimation();
    }
});

// 错误处理
window.addEventListener('error', function(e) {
    console.error('页面错误:', e.message);
    showMessage('发生错误，请查看控制台', 5000);
});
</script>
</body>
</html>
