<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>3D图片画廊</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 解决 favicon.ico 404 -->
<link rel="icon" href="./d1.jpg">

<style>
html,body{
  height:100%;
  margin:0;
  overflow:hidden;
  background:#000;
  font-family:Helvetica,Arial,sans-serif;
}
#container{width:100%;height:100%}
.element{
  width:150px;
  height:150px;
  box-shadow:0 0 12px rgba(0,255,255,.5);
  border:1px solid rgba(127,255,255,.25);
  cursor:pointer;
  transition:transform 0.3s, box-shadow 0.3s;
  overflow:hidden;
}
.element:hover{
  transform:scale(1.05);
  box-shadow:0 0 20px rgba(0,255,255,0.8);
}
.element img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}
#menu{
  position:fixed;
  bottom:20px;
  width:100%;
  text-align:center;
  z-index:10;
}
button{
  background:rgba(0,0,0,0.7);
  border:1px solid rgba(127,255,255,.75);
  color:rgba(127,255,255,.75);
  padding:8px 16px;
  margin:0 5px;
  cursor:pointer;
  border-radius:4px;
  font-size:14px;
  transition:all 0.3s;
}
button:hover{
  background:rgba(127,255,255,.3);
  transform:translateY(-2px);
}
#loading{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#0ff;
  font-size:20px;
  z-index:100;
}
</style>
</head>

<body>
<div id="loading">加载3D场景中...</div>
<div id="container"></div>

<div id="menu">
  <button onclick="transform('table',2000)">表格</button>
  <button onclick="transform('sphere',2000)">球形</button>
  <button onclick="transform('helix',2000)">螺旋</button>
  <button onclick="transform('grid',2000)">网格</button>
  <button onclick="randomLayout()">随机</button>
</div>

<!-- ✅ 正确引入 Three.js 和相关模块 -->
<!-- 先引入 Three.js 核心 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/build/three.min.js"></script>
<!-- 引入 CSS3DRenderer（必须）-->
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/renderers/CSS3DRenderer.js"></script>
<!-- 引入 TrackballControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.154.0/examples/js/controls/TrackballControls.js"></script>
<!-- 引入 Tween.js 用于动画 -->
<script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

<script>
// 全局变量
let camera, scene, renderer, controls;
let objects = [];
let targets = { table: [], sphere: [], helix: [], grid: [] };
let currentTarget = 'table';

// 图片列表
const imageFiles = ['d1.jpg', 'd1.jpg', 'd1.jpg', 'd1.jpg']; // 可以修改为您自己的图片

// 检查依赖是否加载
function checkDependencies() {
  if (typeof THREE === 'undefined') {
    console.error('THREE 未加载');
    return false;
  }
  if (typeof THREE.CSS3DObject === 'undefined') {
    console.error('CSS3DObject 未定义，请检查 CSS3DRenderer 是否正确加载');
    return false;
  }
  if (typeof THREE.CSS3DRenderer === 'undefined') {
    console.error('CSS3DRenderer 未定义');
    return false;
  }
  if (typeof THREE.TrackballControls === 'undefined') {
    console.error('TrackballControls 未定义');
    return false;
  }
  if (typeof TWEEN === 'undefined') {
    console.error('TWEEN 未定义');
    return false;
  }
  return true;
}

// 初始化
function init() {
  // 检查依赖
  if (!checkDependencies()) {
    document.getElementById('loading').innerHTML = '加载失败，请检查控制台错误';
    return;
  }
  
  // 创建相机
  camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 10000);
  camera.position.z = 3000;
  
  // 创建场景
  scene = new THREE.Scene();
  
  // 创建3D对象
  createObjects();
  
  // 创建目标位置
  createTargets();
  
  // 创建渲染器
  try {
    renderer = new THREE.CSS3DRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('container').appendChild(renderer.domElement);
  } catch (error) {
    console.error('创建 CSS3DRenderer 失败:', error);
    document.getElementById('loading').innerHTML = '创建3D渲染器失败: ' + error.message;
    return;
  }
  
  // 创建控制器
  try {
    controls = new THREE.TrackballControls(camera, renderer.domElement);
    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.8;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = true;
    controls.dynamicDampingFactor = 0.3;
    controls.minDistance = 500;
    controls.maxDistance = 6000;
  } catch (error) {
    console.error('创建 TrackballControls 失败:', error);
  }
  
  // 初始变换到表格布局
  transform('table', 0);
  
  // 隐藏加载提示
  document.getElementById('loading').style.display = 'none';
  
  // 窗口大小调整事件
  window.addEventListener('resize', onWindowResize);
  
  // 开始动画循环
  animate();
}

function createObjects() {
  // 清除现有对象
  objects.forEach(obj => {
    if (obj && obj.parent) {
      scene.remove(obj);
    }
  });
  objects = [];
  
  // 创建图片卡片
  for (let i = 0; i < 60; i++) { // 减少到60个提高性能
    const element = document.createElement('div');
    element.className = 'element';
    
    // 创建图片元素
    const img = document.createElement('img');
    const imgIndex = i % imageFiles.length;
    
    // 设置图片源
    img.src = imageFiles[imgIndex];
    img.alt = `图片 ${i + 1}`;
    img.onerror = function() {
      // 图片加载失败时显示占位符
      this.style.backgroundColor = '#0a192f';
      this.style.backgroundImage = 'linear-gradient(45deg, #0ff 25%, transparent 25%, transparent 50%, #0ff 50%, #0ff 75%, transparent 75%, transparent)';
      this.style.backgroundSize = '20px 20px';
    };
    
    element.appendChild(img);
    
    // 创建CSS3D对象
    let object;
    try {
      object = new THREE.CSS3DObject(element);
    } catch (error) {
      console.error('创建 CSS3DObject 失败:', error, 'i=' + i);
      continue; // 跳过这个对象继续创建
    }
    
    // 随机位置
    object.position.x = Math.random() * 4000 - 2000;
    object.position.y = Math.random() * 4000 - 2000;
    object.position.z = Math.random() * 4000 - 2000;
    
    // 添加到场景
    scene.add(object);
    objects.push(object);
  }
  
  console.log(`创建了 ${objects.length} 个3D对象`);
}

function createTargets() {
  // 清空目标数组
  targets = { table: [], sphere: [], helix: [], grid: [] };
  
  // 表格布局
  for (let i = 0; i < objects.length; i++) {
    const target = new THREE.Object3D();
    target.position.x = (i % 10) * 300 - 1500;
    target.position.y = (-Math.floor(i / 10) * 220) + 1000;
    target.position.z = 0;
    targets.table.push(target);
  }
  
  // 球形布局
  for (let i = 0; i < objects.length; i++) {
    const target = new THREE.Object3D();
    const phi = Math.acos(-1 + (2 * i) / objects.length);
    const theta = Math.sqrt(objects.length * Math.PI) * phi;
    
    target.position.x = 800 * Math.sin(phi) * Math.cos(theta);
    target.position.y = 800 * Math.cos(phi);
    target.position.z = 800 * Math.sin(phi) * Math.sin(theta);
    targets.sphere.push(target);
  }
  
  // 螺旋布局
  for (let i = 0; i < objects.length; i++) {
    const target = new THREE.Object3D();
    const radius = 900;
    const theta = i * 0.175 + Math.PI;
    const y = -(i * 5) + 450;
    
    target.position.x = radius * Math.cos(theta);
    target.position.y = y;
    target.position.z = radius * Math.sin(theta);
    targets.helix.push(target);
  }
  
  // 网格布局
  for (let i = 0; i < objects.length; i++) {
    const target = new THREE.Object3D();
    target.position.x = ((i % 5) * 400) - 800;
    target.position.y = (-(Math.floor(i / 5) % 5) * 300) + 500;
    target.position.z = (Math.floor(i / 25)) * 400 - 800;
    targets.grid.push(target);
  }
  
  console.log('目标位置创建完成:', targets);
}

function transform(targetName, duration) {
  // 安全检查
  if (!targets[targetName] || targets[targetName].length === 0) {
    console.error('目标数组不存在或为空:', targetName);
    return;
  }
  
  // 确保数组长度匹配
  if (targets[targetName].length !== objects.length) {
    console.warn('目标数组与对象数组长度不匹配，重新创建目标');
    createTargets();
  }
  
  TWEEN.removeAll();
  currentTarget = targetName;
  
  for (let i = 0; i < objects.length; i++) {
    const object = objects[i];
    const target = targets[targetName][i];
    
    // 安全检查
    if (!object || !target) {
      console.warn(`对象或目标未定义: 索引 ${i}`);
      continue;
    }
    
    new TWEEN.Tween(object.position)
      .to({
        x: target.position.x,
        y: target.position.y,
        z: target.position.z
      }, duration)
      .easing(TWEEN.Easing.Exponential.InOut)
      .start();
  }
  
  console.log(`变换到 ${targetName} 布局`);
}

function randomLayout() {
  const layouts = ['table', 'sphere', 'helix', 'grid'];
  const randomLayout = layouts[Math.floor(Math.random() * layouts.length)];
  transform(randomLayout, 2000);
}

function onWindowResize() {
  if (camera && renderer) {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }
}

function animate() {
  requestAnimationFrame(animate);
  TWEEN.update();
  if (controls) controls.update();
  if (renderer && scene && camera) {
    renderer.render(scene, camera);
  }
}

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
  console.log('页面加载完成，开始初始化...');
  console.log('THREE 版本:', THREE.REVISION);
  console.log('THREE.CSS3DObject:', typeof THREE.CSS3DObject);
  console.log('THREE.CSS3DRenderer:', typeof THREE.CSS3DRenderer);
  console.log('THREE.TrackballControls:', typeof THREE.TrackballControls);
  console.log('TWEEN:', typeof TWEEN);
  
  // 延迟初始化以确保所有依赖已加载
  setTimeout(init, 100);
});
</script>
</body>
</html>
